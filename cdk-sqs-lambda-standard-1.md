+++
title = "Standard SQS + Lambdaの設定実験1"
date = "2021-04-08"
tags = ["SQS", "Lambda"]
+++

[記事](/aws/cdksqs-lambda-standard)の続き1。

* バッチサイズ: 指定なし
* Lambda関数の同時実行数: 指定なし

[CDKのコード](https://github.com/suzukiken/cdksqs-lambda-standard)

バッチサイズの指定がない場合[AWSドキュメント](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-sqs.html)
に

> Lambdaは、キュー内の最大 10 個のメッセージを一度にポーリングし、そのバッチを関数に送信します。

と書かれているように最大10個のSQSメッセージが一括された1つのeventになってLambda関数にに与えられる。実際CloudWatch Logsのメッセージを見ると少ない時は1、多い時は10のメッセージを1回の関数呼び出して処理していることがわかる。

![img](/img/2021/04/lambda-batch.png)

だからLambda関数の`timeout`は1つのメッセージを処理するのにかかる時間の最低10倍の必要になる。なので今回タイムアウトは12秒を設定した。これで実際にテスト中にタイムアウトは起きなかった。

なおタイムアウトが発生した場合CloudWatch Logsを`timed out`で検索するとその呼び出しが特定できる。

Lambda関数の同時実行数についてはその指定をしない場合

[AWSドキュメント](https://aws.amazon.com/jp/premiumsupport/knowledge-center/lambda-sqs-scaling/)に

> Lambda の最大同時実行数は 5 から始まります。（中略）
> 1 分あたり 60 の追加インスタンスを最大 1,000 の同時呼び出しにスケールアップできます。

とあるように、特に決まった数ではなく未処理のメッセージがあってAWSアカウントにまだLambda関数のプールが余っていれば同時実行数は増えてゆくことになる。

実験では300のメッセージをSQSに一気（といっても1、2秒程度で）に投入してLambda関数のモニタリングで確認したが、何度か試して同時実行数は最大で19になった。

![img](/img/2021/04/lambda-standard.png)

SQSのメッセージの不可視期間については、単純にLambda関数のタイムアウトより若干長めの15秒にしておけば問題なかった。

少なくとも今回の実験では、Lambdaのスケール可能なプール（約1000）に比べてメッセージの数（実験では300）がずっと小さいので、必要なだけ関数が同時に立ち上がって同時に処理するから余計な待ち時間みたいなものを考慮する必要はない、ということなのだろう。スロットルも発生していないことからそう考えた。

inflightのメッセージの数は大体100-150程度が処理が終わるまでの間、取り込まれているように見えた。

![img](/img/2021/04/sqs-standard.png)

300件のメッセージの投入を3回試した結果、3回とも全てのメッセージが処理された。

処理にかかった時間は

* 26.318秒
* 30.298秒
* 30.887秒

となった。

Lambda関数の呼び出し回数はCloudWatch Logs Insightで集計したところ、この3回のテストの都合900件のメッセージに対して115回だった。
