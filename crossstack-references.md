+++
title = "クロススタック参照のリソースの入れ替え"
date = "2021-05-09"
tags = ["CloudFormation"]
+++

クロススタック参照になっている場合にOutputをしている方のスタックを`cdk destroy`しようとすると

> destroy failed Error: Failed to destroy XXXXX: CREATE_COMPLETE

となって（なんの問題も起きなかったが如く）削除されずにスタックが残る。

クロススタック参照をしているとそもそもOutputの値が何であるかに関わらず、ImportValueされているだけでこうしてOutputしているスタックの削除が拒否される。

Outputしているスタックの削除をしたい場合はImportValueしている方のスタックを削除するかImportValueするのをやめるしかない（というか他に方法があるのかもしれないが知らない）。

これは問題の発生を前もって排除してくれるというメリットがある代わりに、あまり融通が効かないというデメリットもある。

実際どれくらい融通が利かないのかが気になるので、ちょっとこんなケースを試してみた。

* DynamoDBのテーブルを作るスタック：テーブルの名前をアウトプット
* AppSyncのAPIを作るスタック：テーブルの名前をインポート

これがデプロイされている状態でテーブルを別のものに入れ替えようと思ったらどうするか。

* DBのスタックでアウトプットのパラメタ名はそのままにして新しいテーブルを用意。アウトプットはその新しいテーブルの名前に変更。古いテーブルは削除。としてcdk deployしてみると以前のDBが利用中だからというエラーメッセージが出てデプロイできない。なおこの際スタックのステータスは「UPDATE_ROLLBACK_COMPLETE」となりシステムとしてはそのまま以前の状態で動作する。
* DBのスタックでアウトプットのパラメタ名はそのままにして、古いテーブルは残したまま、新しいテーブルも作りその新しいテーブル名をアウトプット。としてcdk deployしてみると以前のDBが利用中だからというエラーメッセージが出てデプロイできない。なおこの際スタックのステータスは「UPDATE_ROLLBACK_COMPLETE」となりシステムとしてはそのまま以前の状態で動作する。つまり上のと同じ結果になる。

やはりテーブルの切り替えをするにはAPIを作るスタックからの参照をやめる必要がある。

* やり方としては色々あると思うけど1つの可能な方法は古いテーブルとアウトプットはそのままに、新しいテーブルを作りそれは別のパラメタとしてアウトプットし、APIのスタックはその新しいアウトプットをインポートするようにしてから古いテーブルを削除する。