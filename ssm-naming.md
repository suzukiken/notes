+++
title = "Systems Mangaerのパラメータ名"
date = "2021-05-09"
tags = ["Systems Mangaer"]
+++

CDKで作ったスタックを連携させる上で色んな方法で情報を共有できる。

## CloudFormationのOutputを一覧する

その中で[クロススタック参照](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html)をしている場合CloudFormationのOutputとImportValueを使うことになるのだけど、どんなパラメータがOutputされているのかを一覧したり検索したいことがあるかもしれない。

その際こんなコマンドを打てば

```
aws cloudformation list-exports
```

100までパラメータがリストアップできるのだけど検索ができるというわけでは無いし、自分が意図して作ったOutput以外にも沢山のOutputがあるだろうからもう少しプログラマチックな解決が必要になるだろうと思う。

特定のパラメータについて参照されているかどうかは

```
aws cloudformation list-imports --export-name <エクスポートした値の名前>
```

のようにすると判る。なのでエクスポートしたものとそれのインポートしているスタックの一覧は、boto3などを使ってスタック間の関連性を一覧できるようにすることは可能ではある。

## Systems Mangaerのパラメータストアを一覧する
Systems Mangaerにパラメータを置ことにすればこんなコマンドラインでパラメータの一覧が取得できる。

```
aws ssm get-parameters-by-path --path *** --recursive
```

これの良いところはど`***`の部分に例えば`/auth/`と指定すればそれで始まるものだけをリストアップするといったことができるところで、命名規則を整えておく必要があるけれど、前述のCloudFormationのOutputsをリストするより楽に探しているものの一覧ができそうに思う。

## Systems Mangaerのパラメータの命名について

ということでSystems Mangaerに置くパラメータ名の付け方としてこういうものがいいんじゃないかというのをちょっと考えてみた。

```
/<決まった接頭辞>/<目的>/<詳細>/リソース/<バージョン>/<ステージ>
```

* 決まった接頭辞: `NS` `v`とか。他のパラメータが混在している中で自分や自分のチームが投入したパラメータであるとわかるように接頭辞をつける。
* 目的: 例えば認証だったらauthとか、データのやり取りのためのリソースならconnとかにする。
* 詳細: 種類の中にいくつかの分類がさらにあるならそれを。例えばシステムAとBの接続をするためのリソースならa-to-bとか。
* リソース: 例えばDynamo DBのテーブルARNなら`dynamodb/table/arn`とか。
* バージョン: スタックは何度か同じ目的で作り直しが発生することが考えられるのでその際にバージョン毎にパラメータを持てるようにしておく。
* 運用と開発で「ステージ」を分けるといったことをするならそれを。

ちなみにバージョンは場合によっては邪魔かもしれない。SSMパラメータはそれ自体の機能として中にバージョンを持つので、CDKのvalueForStringParameterを使って値を得る場合はそのバージョンを指定できる。なのでパラメタ名にバージョン番号をつけると混乱の元になってしまうように思う。

valueFromLookUpを使う場合は最新バージョンしか参照できないので命名に含めておきたくなると思う。

バージョンやステージについては誤った値を登録してしまうことがありがちな気がするので無いに越したことはないんだろうけど。