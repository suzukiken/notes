+++
title = "Standard SQS + Lambdaの設定実験3"
date = "2021-04-08"
tags = ["SQS", "Lambda"]
+++

[記事](/aws/cdksqs-lambda-standard)の続き3。

* バッチサイズ: 指定なし
* Lambda関数の同時実行数: 1

[CDKのコード](https://github.com/suzukiken/cdksqs-lambda-standard)

バッチサイズの指定をしないでLambda関数の同時実行数だけは1にするという設定ではどうなるか。

バッチサイズについては、[AWSドキュメント](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-sqs.html)の通り未指定の場合は最大10となる。このことはCloudWatch Logsを見ても確認できる。

そのためLambda関数のタイムアウトは、10件のメッセージを処理するのにかかる時間を設定しておけばタイムアウトは発生しない。今回の実験でも1メッセージに1秒かかるように関数を作ってあるので、タイムアウトは10倍の10秒に少し余裕を食えて12秒に設定して実際にタイムアウトは発生しなかった。

Lambda関数の同時実行数は1を指定しているのでLambdaのモニタリングで見ても1となっている。

![img](/img/2021/04/lambda-standard-conc.png)

#### SQSのメッセージの不可視期間について

maxReceiveCountを1に指定している状態では、この期間は相当長くしない限りデッドレターが発生する。具体的には300秒に指定しても、相変わらずデッドレターが発生した。300秒というのはもはや300件のメッセージ全ての処理を終えるのにかかった時間に近い。

不可視なメッセージはAWSコンソールでSQSの「処理中のメッセージ」を見ていると80-120程度になる。

![img](/img/2021/04/sqs-standard-conc.png)

なので他の実験と同様にバッチサイズの10倍程度のメッセージが不可視となるという見方と大きく乖離しない。

ちなみに同時実行数の設定が、不可視になるメッセージの数に影響するか確認したいと思って同時実行数を2に増やして試したが、同時実行数を1に指定した場合と比べて不可視メッセージの数が大きくなるようには見えなかった。

![img](/img/2021/04/sqs-standard-conc-5.png)

cdksqslambdastandardconc: 同時実行数1
cdksqslambdastandardconc5: 同時実行数2

話は戻って不可視メッセージが100程度だとすると、不可視タイムアウトは100秒程度で良いのではないかと思うのだが、それでは足りず300秒も必要になるということはどういう考えたらいいのか。

1つの考えとしてはSQSとLambda関数の間の**何か**が取り込んだメッセージが置かれる**キューのようなもの**があって、このキューは**先入先出ではない**のということではないか。

Lambdaのモニタリングでは[実験2](/aws/cdksqs-lambda-standard-2)の場合と異なりスロットルが発生していることがわかる。

つまりLambdaが（SQSではない）キューにメッセージを取り込んだ後、そのキューは順番に処理されるわけではなくそこに滞留していて、そこには新しいメッセージも引き続き取り込まれ続けて、大体バッチサイズの10倍程度のメッセージが存在し続ける。FIFOではないから場合によっては最初に取り込まれたメッセージが最後の方まで残り続けることもあるので、300秒といった長い期間を指定しておく方がエラーの発生が減る、というようなことなのだろうか。

もしそうだとしてさらに謎なのは、メッセージの処理にかかった時間が後述する320秒程度であるのに対して、不可視期間が300秒でmaxReceiveCountが1、つまりAWSのドキュメントによれば2回Lambdaに渡されてそれでも処理できなかったものがデッドレターになるということだとしたら、全体の処理に600秒以上かかっていないと辻褄が合わないように思うがエラーになったメッセージはどんな動きをしたのだろうか。

#### 300件の処理にかかる時間

3回実行

300件全て処理成功: 2
一部失敗: 1

失敗の詳細は、290件成功し、10件のメッセージがデッドレターキューに入った。

処理にかかった時間

* 321.653秒
* 332.889秒
* 345.202秒

同時実行数が1だからどれだけ急いでも実験に使った300件のメッセージの処理には300秒以上かかるわけで、結果はごく当たり前の数字のように見えるが、この先に書く4の実験結果を見るとバッチサイズが10であることが随分大きな差を産むのだと知った。

差が生まれているのは多分Lambda関数の呼び出し回数で、CloudWatch Logs Insightで集計したところではこの3回のテストの都合900件のメッセージに対して、10回取りこぼしたので合計890件の処理に対して呼び出し回数が111回だった。

そこからわかるのは平均的に1回のLambda関数実行のために1秒程度の余計な時間がかかっているということだが、関数の呼び出し回数自体が少ないことで実験4に比べて全体にはとても早く終わっている。