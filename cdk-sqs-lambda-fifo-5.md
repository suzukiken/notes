+++
title = "FIFO SQS + Lambdaの設定 実験5"
date = "2021-04-09"
tags = ["SQS", "Lambda"]
+++

[記事](/aws/cdksqs-lambda-fifo)の続き、実験5。

* バッチサイズ: 指定なし
* Lambda関数の同時実行数: 1
* メッセージグループIDのバリエーション: 5

[CDKのコード](https://github.com/suzukiken/cdksqs-lambda-fifo)

## Lambda関数のタイムアウト

この実験ではバッチサイズの指定をしていないので、最大バッチサイズはデフォルトの10となる。
Lambda関数は1つのメッセージを処理するのに1秒かかるように作ってあるので、
タイムアウトは10秒以上を指定する必要があり、今回は12秒にしておいた。
これで実験中にタイムアウトは発生していない。

## Lambda関数の同時実行数

メッセージグループが5つあるが、Lambda関数の同時実行数は1を指定しているので、実際に同時実行数は1となる。

![img](/img/2021/04/lambda-fifo-conc-group-5.png)

## 不可視メッセージ数

バッチサイズが10でメッセージグループが5つあるので、inflightのメッセージの数は50になっているのだろう。

バッチサイズ:10 x メッセージグループ数:5 = 不可視メッセージ数:50

![img](/img/2021/04/sqs-fifo-conc-gropu-5.png)

ただ、同時実行数が1に制限されているため、50件ものメッセージをLambdaが取り込んでしまうと、
それを消化するには時間がかかるわけで、それがLambda関数のモニタリングで見られたスロットルの原因なのだろう。

## メッセージの不可視期間

この実験ではmaxReceiveCountを1にしている。
そのため

可視 -> 不可視 -> 可視 -> 不可視 -> デッドレター

という風に3回目のチャンスは与えられずエラーとなる。
（これは[AWSのドキュメント](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html)の内容を私はそう解釈しているという意味）

タイムアウト時間を決めるために何度か設定を変更して、デッドレターが発生する件数を確認した。

| 不可視タイムアウト(秒) |  デッドレター件数 |
|------------------------|-------------------|
| 15                     | 200               |
| 100                    | 50                |
| 200                    | 11                |
| 250                    | 0                 |
| 220                    | 1                 |
| 230                    | 10                |
| 240                    | 0                 |
| 240                    | 1                 |
| 240                    | 10                |

この結果から相変わらずエラーにはなるものの、以降の実験では240秒を採用した。

なお、maxReceiveCountは5以上にすることで、メッセージがデッドレターになる可能性を減らすことができる、
と[書かれている](https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html)が、
敢えてそうしていないのは、これは運用目的ではなく、SQSとLambdaの関係を把握するための実験だからで、
自分も本運用時には5以上を指定するつもりでいる。

## 実験結果

300件のメッセージを投入する実験を3回試した。
メッセージグループは5つで、それぞれ均等に60件ずつのメッセージが同じ1つのメッセージグループとなっている。

3回のうち全て処理できたのが1回、後の2回はDLQにメッセージが移動されたものがあった。

| 成功 | デッドレター |
|------|--------------|
| 300  | 0            |
| 299  | 1            |
| 290  | 10           |

成功したメッセージの処理にかかった時間は

* 320.779秒
* 324.742秒
* 336.947秒

成功した889件のメッセージに対してLambda関数の呼び出しは103回。
バッチサイズは平均8.6ということになる。

[実験1](/aws/cdksqs-lambda-fifo-1)と比べて、より遅く、エラーまで発生している。

実験1との違いはこのようなものだ。

|               | Lambda関数の同時実行数の指定 | メッセージグループIDのバリエーション | 処理にかかった平均時間（秒） |
|---------------|------------------------------|--------------------------------------|------------------------------|
| 実験1         | 指定しない                   | 1                                    | 301.82                       |
| 実験5（今回） | 1                            | 5                                    | 327.49                       |

実験1では同時実行数をコードでは指定していないが、実際にはメッセージグループIDが1種類しかないので、同時実行数は1となる。
実験5ではLambda関数の同時実行数を1に制限したので、当然同時実行数は1となる。
どちらも同じような結果になるかと思うが、実際には、実験5は処理に余計に時間がかかり、エラーまで出たわけなので、
当然同時実行数1の指定は悪影響を与えたことになる。

