+++
title = "Googleのアカウントを使ってCognitoで認証する2つの方法"
date = "2021-02-23"
tags = ["Google", "Cognito"]
+++

CognitoにGoogleアカウントでSSOする方法について2つの方法があってそれぞれの違いをまとめた。

## Cognito

まずサービスを小分けにして作っていく場合、それぞれのサービスが独自に認証システムを持つのは不便なので、ユーザー管理を一本化できる認証基盤があると便利だ。

認証基盤としてはAuth0などのサードパーティのサービスもあけれど、AWSでマイクロサービスを作るという前提だとCognitoが最初の候補となると思う。

実際Auth0のことは自分はよく知らないが、Cognitoよりも使いやすく分かりやすいものという印象はある。

ただCognitoのデプロイをCDKで行うことにして、クライアント側にAmplifyを使うなら、そうしたわかりにくさ使いにくさなどはほとんど感じないようにも思うので、以前使ってかなりイライラしたり混乱したりした経験のあるAWSユーザーの方にも今のCognitoは悪くないということをまずはお伝えしておきたい。

## Googleと繋ぐ

Googleのアカウントを会社などで利用している場合、社員がそのアカウントでログインと便利だし、パスワードを登録したり覚えたり入力したりするのは面倒なので、Googleを使ってSSOが可能な認証基盤を作ることにする。

ちなみにCognitoではGoogle以外のFacebookとかいくつかのサービスとも連携できるが、ここではGoogleだけに絞る。またID/PWでのログインはしないという前提で作ることにする。

## 導入の方法は２つある

Google Workspaceに`example.com`というアカウントがある場合を例にすると、やり方は2つある。

![img](/img/2021/02/CognitoEitherWay.png)

- A. ユーザープールとIdプールを使う方法
- B. Idプールだけでやる方法

違いはこのようなもの。

 &nbsp; | A. ユーザープール利用 | B. Idプールだけ
------|------|------
 デプロイの手間 | 面倒 | 楽
 Googleライセンス | 無償のGmailでも良い | Workspace有償アカウントが必要
 細かいユーザー管理 | できる | できない
 ユーザー制限 | ユーザープール | Google
 
### AとBの選択
 
もし`example.com`のメンバーだけに公開し、全員一律同じ権限で良い、という場合にはBで良い。
ユーザー管理らしいことをするならAになる。

Aでできること。（Bではできないこと）

* `example.com`以外のユーザーにもシステムを解放できる
* `example.com`の中でも特定のメールアドレスのアカウントはブラックリスト化できる
* Google認証だけでなくID＆パスワードでのログイン機能が追加できる
* ユーザーのグループを作ってグループ毎の権限を付与できる

それぞれのデプロイのためにやることを別記事に書いた。


### A ユーザープールを使う方法

* [バックエンド](/aws/cognito-user-pool-with-google-auth)
* [フロントエンド（ウェブ）](/aws/amplify-googleauth-cognitouserpool)

### A ユーザープールを使う方法

* [バックエンド](/aws/cognito-id-pool-with-google-auth)
* [フロントエンド（ウェブ）](/aws/amplify-googleauth-cognitoidpool)
