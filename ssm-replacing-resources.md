+++
title = "Systems Managerのパラメータで共有したリソースの入れ替え"
date = "2021-05-09"
tags = ["CloudFormation", "Systems Manager"]
+++

Systems Managerを介して複数のスタックで値を共有しているとして、その値をあるいはそのリソースを入れ替える場合にどうなるか、ちょっとこんなケースを考えてみた。

* DynamoDBのテーブルを作るスタック：テーブルの名前をSystems Managerのパラメータに残す
* AppSyncのAPIを作るスタック：テーブルの名前をSystems ManagerのパラメータからvalueFromLookupで得る。

これがデプロイされている状態でテーブルを別のものに入れ替える。

まずDB側のスタックで古いテーブルを削除して、新しいテーブルを作りその名前を今までと同じSystems Managerパラメータに書き残すことは何の問題もなくできる。

この辺りはクロススタック参照に比べると自由な感じでメンテが楽という考え方もあるけど、AppSync側はAPIコールをしたらテーブルが存在しないのでアプリケーションとしては動作しない状態になる。

アプリケーションを動作させるためにはAppSyncが参照するテーブルを変更する必要がある。これはvalueFromLookupを使ってSystems Managerパラメータを参照している場合、もしcdk.contex.jsonが既にあるならそれを捨てて`cdk deploy`すれば新しいテーブル名が取り込まれてAppSyncに反映される。

一時的にアプリケーションが止まるけれどそれが問題ないなら、こうした作業はクロススタック参照しているのに比べると楽ではある。逆にアプリケーションの動作に影響することを知らずにやってしまうという危険もある。

ここではvalueFromLookupを使う前提で書いたけどvalueForStringParameterでも動作は同じだと思う。試してないけど。


