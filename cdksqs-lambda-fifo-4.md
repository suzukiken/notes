+++
title = "FIFO SQS + Lambdaの設定実験4"
date = "2021-04-09"
tags = ["SQS", "Lambda"]
+++

[記事](/aws/cdksqs-lambda-fifo)の続き、実験4。

* バッチサイズ: 1
* Lambda関数の同時実行数: 指定なし
* メッセージグループIDのバリエーション: 5

[CDKのコード](https://github.com/suzukiken/cdksqs-lambda-fifo)

これは[実験2](/aws/cdksqs-lambda-fifo-2)と同じ設定のまま、メッセージグループのバリエーションを5にしたもの。
実験2では、投入されるメッセージのメッセージグループは全て同じにしたが、こちらは5つのバリエーションを持たせた。

この実験ではバッチサイズの指定を1としているので、
AWSコンソールのSQSの一覧画面をリロードしながら見ていると、inflightのメッセージの数は5となる。

つまり
バッチサイズ:1 x メッセージグループ数:5 = 不可視メッセージ数:5
ということになっているのだと思う。

![img](/img/2021/04/sqs-fifo-batch-gropu-5.png)

AWSコンソールでLambdaのモニタリングで見ると、Lambda関数の同時実行数は5となる。

![img](/img/2021/04/lambda-fifo-batch-group-5.png)

スロットリングは全く見られない。

## 実験結果

300件のメッセージを投入する実験を3回試した。
メッセージグループは5つで、それぞれ均等に60件ずつのメッセージが同じ1つのメッセージグループとなっている。
3回とも全てのメッセージの処理が成功し、1件もDLQに移動されたメッセージはなかった。

処理にかかった時間は

* 63.452秒
* 63.635秒
* 62.79秒

900件のメッセージに対してLambda関数の呼び出しは900回
5つのLambda関数が同時実行されているので、1つのインスタンスが60回呼び出されているということになる。

[実験2](/aws/cdksqs-lambda-fifo-1)の約5倍の速度で処理を終えていることがわかる。
つまり早く処理を終えたいならメッセージグループIDをなるべく分けるのが良いということになる。

[実験3](/aws/cdksqs-lambda-fifo-3)に対して、平均して処理速度の差は0.8%となった。
つまりバッチサイズを大きくしてもほとんど早くならないということになる。