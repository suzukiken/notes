+++
title = "FIFO SQS + Lambdaの設定実験3"
date = "2021-04-09"
tags = ["SQS", "Lambda"]
+++

[記事](/aws/cdksqs-lambda-fifo)の続き、実験3。

* バッチサイズ: 指定なし
* Lambda関数の同時実行数: 指定なし
* メッセージグループIDのバリエーション: 5

[CDKのコード](https://github.com/suzukiken/cdksqs-lambda-fifo)

これは[実験1](/aws/cdksqs-lambda-fifo-1)と同じ設定のまま、メッセージグループのバリエーションを5にしたもの。
実験1では、投入されるメッセージのメッセージグループは全て同じにしたが、こちらは5つのバリエーションを持たせた。

この実験ではバッチサイズの指定をしていないので、最大バッチサイズはデフォルトの10となる。
AWSコンソールのSQSの一覧画面をリロードしながら見ていると、inflightのメッセージの数は50となる。

[実験1](/aws/cdksqs-lambda-fifo-1)ではinflightのメッセージの数は10だったが、こちらがその5倍なのは、
メッセージグループが5つあるためだろう。

つまり
バッチサイズ:10 x メッセージグループ数:5 = 不可視メッセージ数:50

![img](/img/2021/04/sqs-fifo-group-5.png)

AWSコンソールでLambdaのモニタリングで見ると、Lambda関数の同時実行数は5となる。

![img](/img/2021/04/lambda-fifo-group-5.png)

スロットリングは全く見られない。

## 実験結果

300件のメッセージを投入する実験を3回試した。
メッセージグループは5つで、それぞれ均等に60件ずつのメッセージが同じ1つのメッセージグループとなっている。
3回とも全てのメッセージの処理が成功し、1件もDLQに移動されたメッセージはなかった。

処理にかかった時間は

* 61.21秒
* 64.759秒
* 62.378秒

900件のメッセージに対してLambda関数の呼び出しは105回
5つのLambda関数が同時実行されているので、1つのインスタンスが平均で21回呼び出されているということになる。

[実験1](/aws/cdksqs-lambda-fifo-1)の約4.8倍の速度で処理を終えていることがわかる。
つまり早く処理を終えたいならメッセージグループIDをなるべく分けるのが良いということになる。